<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¹€ì—„ë§ˆ ë…ì„œì‹¤ - PC/íƒœë¸”ë¦¿ ì •ê¸°ì ê²€</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #dbeafe;
            --success: #10b981;
            --success-light: #d1fae5;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --danger: #ef4444;
            --danger-light: #fee2e2;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --floor-7: #8b5cf6;
            --floor-7-light: #ede9fe;
            --floor-8: #0891b2;
            --floor-8-light: #cffafe;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            min-height: 100vh;
            color: var(--gray-800);
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        header {
            background: white;
            border-radius: 16px;
            padding: 24px 32px;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }
        .logo { display: flex; align-items: center; gap: 12px; }
        .logo-icon {
            width: 48px; height: 48px;
            background: linear-gradient(135deg, var(--primary), var(--floor-7));
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px;
        }
        .logo h1 { font-size: 24px; font-weight: 700; }
        .logo p { font-size: 14px; color: var(--gray-500); }
        
        .sync-status {
            display: flex; align-items: center; gap: 8px;
            padding: 8px 16px;
            background: var(--gray-100);
            border-radius: 20px;
            font-size: 13px;
            color: var(--gray-600);
            cursor: pointer;
        }
        .sync-status.syncing { background: var(--primary-light); color: var(--primary); }
        .sync-status.connected { background: var(--success-light); color: var(--success); }
        .sync-status.error { background: var(--danger-light); color: var(--danger); }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; }
        .sync-status.syncing .sync-dot { animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        
        .header-stats { display: flex; gap: 24px; flex-wrap: wrap; }
        .stat-card { text-align: center; padding: 12px 20px; background: var(--gray-50); border-radius: 12px; }
        .stat-card .number { font-size: 28px; font-weight: 700; color: var(--primary); }
        .stat-card .label { font-size: 12px; color: var(--gray-500); }
        .stat-card.warning .number { color: var(--danger); }
        
        .main-content { display: grid; grid-template-columns: 1fr 380px; gap: 24px; }
        @media (max-width: 1024px) { .main-content { grid-template-columns: 1fr; } }
        
        .panel {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .panel-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }
        .panel-title { font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        
        .filters { display: flex; gap: 8px; flex-wrap: wrap; }
        .filter-btn {
            padding: 8px 16px;
            border: 2px solid var(--gray-200);
            background: white;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            font-family: inherit;
        }
        .filter-btn:hover { border-color: var(--primary); color: var(--primary); }
        .filter-btn.active { background: var(--primary); border-color: var(--primary); color: white; }
        .filter-btn.floor-7.active { background: var(--floor-7); border-color: var(--floor-7); }
        .filter-btn.floor-8.active { background: var(--floor-8); border-color: var(--floor-8); }
        
        .search-box { padding: 16px 24px; background: var(--gray-50); border-bottom: 1px solid var(--gray-200); }
        .search-input {
            width: 100%;
            padding: 10px 16px;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }
        .search-input:focus { outline: none; border-color: var(--primary); }
        
        .progress-section { padding: 16px; background: var(--gray-50); }
        .progress-bar { height: 8px; background: var(--gray-200); border-radius: 4px; overflow: hidden; margin-bottom: 8px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--success), var(--primary)); transition: width 0.3s; }
        .progress-text { font-size: 13px; color: var(--gray-600); text-align: center; }
        
        .student-list { max-height: 600px; overflow-y: auto; }
        .student-item {
            display: flex;
            align-items: center;
            padding: 16px 24px;
            border-bottom: 1px solid var(--gray-100);
            gap: 16px;
        }
        .student-item:hover { background: var(--gray-50); }
        .student-item.overdue { background: var(--danger-light); }
        .student-item.today { background: var(--warning-light); }
        
        .floor-badge { padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; }
        .floor-badge.floor-7 { background: var(--floor-7-light); color: var(--floor-7); }
        .floor-badge.floor-8 { background: var(--floor-8-light); color: var(--floor-8); }
        
        .student-info { flex: 1; }
        .student-name { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
        .student-status { font-size: 13px; color: var(--gray-500); }
        .student-status.overdue { color: var(--danger); font-weight: 500; }
        
        .check-btn {
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            font-family: inherit;
        }
        .check-btn:hover { background: var(--primary-dark); }
        
        .today-panel { position: sticky; top: 20px; }
        .today-list { padding: 16px; }
        .today-item {
            background: linear-gradient(135deg, var(--warning-light) 0%, #fde68a 100%);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 2px solid var(--warning);
        }
        .today-item .priority-num {
            width: 32px; height: 32px;
            background: var(--warning);
            color: white;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 14px;
        }
        
        .daily-count { display: flex; align-items: center; gap: 8px; margin-bottom: 16px; }
        .daily-count label { font-size: 14px; color: var(--gray-600); }
        .daily-count input {
            width: 60px; padding: 8px 12px;
            border: 2px solid var(--gray-200);
            border-radius: 8px; font-size: 14px; text-align: center;
        }
        
        .refresh-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--primary), var(--floor-7));
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            margin-top: 8px;
        }
        
        .data-actions { display: flex; gap: 8px; padding: 16px; border-top: 1px solid var(--gray-200); background: var(--gray-50); flex-wrap: wrap; }
        .data-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--gray-300);
            background: white;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            font-family: inherit;
            min-width: 80px;
        }
        .data-btn:hover { border-color: var(--primary); color: var(--primary); }
        .data-btn.danger { border-color: var(--danger); color: var(--danger); }
        .data-btn.danger:hover { background: var(--danger); color: white; }
        
        .history-panel { margin-top: 24px; }
        .history-list { padding: 16px; max-height: 300px; overflow-y: auto; }
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--gray-50);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .history-item .date { font-size: 13px; color: var(--gray-500); }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        .modal h3 { font-size: 20px; margin-bottom: 8px; }
        .modal p { color: var(--gray-500); margin-bottom: 24px; }
        .modal-buttons { display: flex; gap: 12px; justify-content: center; }
        .modal-btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            font-family: inherit;
            border: none;
        }
        .modal-btn.cancel { background: var(--gray-200); color: var(--gray-700); }
        .modal-btn.confirm { background: var(--success); color: white; }
        
        .settings-form { text-align: left; margin-bottom: 24px; }
        .settings-form label { display: block; font-size: 14px; font-weight: 500; margin-bottom: 8px; }
        .settings-form input {
            width: 100%; padding: 12px 16px;
            border: 2px solid var(--gray-200);
            border-radius: 8px; font-size: 14px; margin-bottom: 16px;
        }
        .settings-form .help-text { font-size: 12px; color: var(--gray-500); margin-top: -12px; margin-bottom: 16px; }
        
        .toast {
            position: fixed;
            bottom: 24px; right: 24px;
            background: var(--gray-800);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            font-size: 14px;
            z-index: 1001;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { background: var(--success); }
        
        .empty-state { padding: 48px 24px; text-align: center; color: var(--gray-500); }
        .empty-state .icon { font-size: 48px; margin-bottom: 16px; }
        
        .connection-banner {
            background: var(--warning-light);
            border: 2px solid var(--warning);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }
        .connection-banner.hidden { display: none; }
        .connection-banner .message { display: flex; align-items: center; gap: 12px; }
        .connection-banner .icon { font-size: 24px; }
        .connection-banner .text h4 { font-size: 14px; font-weight: 600; }
        .connection-banner .text p { font-size: 13px; color: var(--gray-600); }
        .connection-banner button {
            padding: 10px 20px;
            background: var(--warning);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="connection-banner" id="connection-banner">
            <div class="message">
                <span class="icon">ğŸ“Š</span>
                <div class="text">
                    <h4>êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—°ê²° í•„ìš”</h4>
                    <p>ì„¤ì •ì—ì„œ Apps Script URLì„ ì…ë ¥í•˜ì„¸ìš”</p>
                </div>
            </div>
            <button onclick="openSettingsModal()">ì—°ê²° ì„¤ì •</button>
        </div>

        <header>
            <div class="logo">
                <div class="logo-icon">ğŸ“±</div>
                <div>
                    <h1>ê¹€ì—„ë§ˆ ë…ì„œì‹¤</h1>
                    <p>PC/íƒœë¸”ë¦¿ ì •ê¸°ì ê²€ ì‹œìŠ¤í…œ</p>
                </div>
            </div>
            <div class="sync-status" id="sync-status" onclick="manualSync()">
                <span class="sync-dot"></span>
                <span class="sync-text">ì˜¤í”„ë¼ì¸</span>
            </div>
            <div class="header-stats">
                <div class="stat-card">
                    <div class="number" id="total-students">0</div>
                    <div class="label">ì „ì²´ í•™ìƒ</div>
                </div>
                <div class="stat-card warning">
                    <div class="number" id="overdue-count">0</div>
                    <div class="label">ì ê²€ í•„ìš”</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="completed-month">0</div>
                    <div class="label">ì´ë²ˆ ë‹¬ ì™„ë£Œ</div>
                </div>
            </div>
        </header>

        <div class="main-content">
            <div class="left-panel">
                <div class="panel">
                    <div class="panel-header">
                        <h2 class="panel-title"><span class="icon">ğŸ‘¥</span> ì „ì²´ í•™ìƒ ëª…ë‹¨</h2>
                        <div class="filters">
                            <button class="filter-btn active" data-filter="all">ì „ì²´</button>
                            <button class="filter-btn floor-7" data-filter="7">7ì¸µ</button>
                            <button class="filter-btn floor-8" data-filter="8">8ì¸µ</button>
                            <button class="filter-btn" data-filter="overdue">âš ï¸ ì ê²€í•„ìš”</button>
                        </div>
                    </div>
                    <div class="search-box">
                        <input type="text" class="search-input" placeholder="í•™ìƒ ì´ë¦„ ê²€ìƒ‰..." id="search-input">
                    </div>
                    <div class="progress-section">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                        </div>
                        <div class="progress-text" id="progress-text">ì ê²€ ì§„í–‰ë¥ : 0%</div>
                    </div>
                    <div class="student-list" id="student-list"></div>
                </div>
            </div>

            <div class="right-panel">
                <div class="panel today-panel">
                    <div class="panel-header">
                        <h2 class="panel-title"><span class="icon">ğŸ¯</span> ì˜¤ëŠ˜ì˜ ì ê²€ ëŒ€ìƒ</h2>
                    </div>
                    <div class="today-list">
                        <div class="daily-count">
                            <label>í•˜ë£¨ ì ê²€ ì¸ì›:</label>
                            <input type="number" id="daily-count" value="6" min="1" max="20">
                            <span>ëª…</span>
                        </div>
                        <div id="today-students"></div>
                        <button class="refresh-btn" id="refresh-btn">ğŸ”„ ì˜¤ëŠ˜ì˜ ì ê²€ ëŒ€ìƒ ë‹¤ì‹œ ì„ ì •</button>
                    </div>
                    <div class="data-actions">
                        <button class="data-btn" onclick="openSettingsModal()">âš™ï¸ ì„¤ì •</button>
                        <button class="data-btn" onclick="exportData()">ğŸ“¥ ë‚´ë³´ë‚´ê¸°</button>
                        <button class="data-btn danger" onclick="resetData()">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
                    </div>
                </div>

                <div class="panel history-panel">
                    <div class="panel-header">
                        <h2 class="panel-title"><span class="icon">ğŸ“‹</span> ìµœê·¼ ì ê²€ ì´ë ¥</h2>
                    </div>
                    <div class="history-list" id="history-list"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="confirm-modal">
        <div class="modal">
            <h3 id="modal-title">ì ê²€ ì™„ë£Œ í™•ì¸</h3>
            <p id="modal-message">í•™ìƒì˜ PC/íƒœë¸”ë¦¿ ì ê²€ì„ ì™„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal()">ì·¨ì†Œ</button>
                <button class="modal-btn confirm" onclick="completeInspection()">âœ“ ì ê²€ ì™„ë£Œ</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="settings-modal">
        <div class="modal">
            <h3>âš™ï¸ êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—°ê²°</h3>
            <p>Apps Script ì›¹ì•± URLì„ ì…ë ¥í•˜ì„¸ìš”</p>
            <div class="settings-form">
                <label>ì›¹ì•± URL</label>
                <input type="text" id="api-url-input" placeholder="https://script.google.com/macros/s/...">
                <p class="help-text">Apps Script ë°°í¬ í›„ ë°›ì€ URLì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”</p>
                <label>ìë™ ë™ê¸°í™” ê°„ê²© (ì´ˆ)</label>
                <input type="number" id="sync-interval-input" value="30" min="10" max="300">
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeSettingsModal()">ì·¨ì†Œ</button>
                <button class="modal-btn confirm" onclick="saveSettings()">ì €ì¥</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        let allStudents = [];
        let inspectionHistory = [];
        let todaySelections = [];
        let todayDate = null;
        let currentFilter = 'all';
        let searchQuery = '';
        let selectedStudent = null;
        
        let apiUrl = localStorage.getItem('pc-inspection-api-url') || '';
        let syncInterval = parseInt(localStorage.getItem('pc-inspection-sync-interval')) || 30;
        let syncTimer = null;
        let isSyncing = false;
        let pendingRecords = [];

        document.addEventListener('DOMContentLoaded', function() {
            loadLocalData();
            startAutoSync();
            setupEventListeners();
            render();
        });

        function setupEventListeners() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.dataset.filter;
                    renderStudentList();
                });
            });
            
            document.getElementById('search-input').addEventListener('input', e => {
                searchQuery = e.target.value;
                renderStudentList();
            });
            
            document.getElementById('refresh-btn').addEventListener('click', () => {
                if (confirm('ì˜¤ëŠ˜ì˜ ì ê²€ ëŒ€ìƒì„ ë‹¤ì‹œ ì„ ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    selectTodayStudents();
                    render();
                    showToast('ğŸ¯ ì ê²€ ëŒ€ìƒì´ ë‹¤ì‹œ ì„ ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
                }
            });
            
            document.getElementById('daily-count').addEventListener('change', () => {
                selectTodayStudents();
                render();
            });
            
            document.getElementById('confirm-modal').addEventListener('click', e => {
                if (e.target.id === 'confirm-modal') closeModal();
            });
            
            document.getElementById('settings-modal').addEventListener('click', e => {
                if (e.target.id === 'settings-modal') closeSettingsModal();
            });
        }

        function loadLocalData() {
            const saved = localStorage.getItem('pc-inspection-data');
            if (saved) {
                const data = JSON.parse(saved);
                allStudents = data.students || [];
                inspectionHistory = data.history || [];
                todaySelections = data.todaySelections || [];
                todayDate = data.todayDate;
                pendingRecords = data.pendingRecords || [];
            }
        }

        function saveLocalData() {
            localStorage.setItem('pc-inspection-data', JSON.stringify({
                students: allStudents,
                history: inspectionHistory,
                todaySelections: todaySelections,
                todayDate: todayDate,
                pendingRecords: pendingRecords
            }));
        }

        function updateSyncStatus(status, text) {
            const el = document.getElementById('sync-status');
            el.className = 'sync-status ' + status;
            el.querySelector('.sync-text').textContent = text;
        }

        async function syncWithServer() {
            if (!apiUrl || isSyncing) return;
            
            isSyncing = true;
            updateSyncStatus('syncing', 'ë™ê¸°í™” ì¤‘...');
            
            try {
                const response = await fetch(`${apiUrl}?action=pc_getAll`);
                const data = await response.json();
                
                if (data.error) throw new Error(data.error);
                
                if (data.students && data.students.length > 0) {
                    allStudents = data.students.map(s => ({
                        name: s.name,
                        floor: s.floor,
                        lastCheck: s.lastCheck
                    }));
                }
                
                if (data.records && data.records.length > 0) {
                    const existingKeys = new Set(inspectionHistory.map(r => 
                        `${r.name}_${r.floor}_${new Date(r.date).getTime()}`
                    ));
                    
                    data.records.forEach(record => {
                        const key = `${record.name}_${record.floor}_${new Date(record.date).getTime()}`;
                        if (!existingKeys.has(key)) {
                            inspectionHistory.push(record);
                        }
                    });
                    
                    inspectionHistory.sort((a, b) => new Date(a.date) - new Date(b.date));
                }
                
                if (pendingRecords.length > 0) {
                    await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'pc_syncRecords', records: pendingRecords })
                    });
                    pendingRecords = [];
                }
                
                if (todaySelections.length === 0 || !todayDate || todayDate !== new Date().toDateString()) {
                    todayDate = new Date().toDateString();
                    selectTodayStudents();
                }
                
                saveLocalData();
                updateSyncStatus('connected', 'ë™ê¸°í™”ë¨ ' + new Date().toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'}));
                render();
                
            } catch (error) {
                console.error('ë™ê¸°í™” ì˜¤ë¥˜:', error);
                updateSyncStatus('error', 'ë™ê¸°í™” ì‹¤íŒ¨');
            } finally {
                isSyncing = false;
            }
        }

        async function saveRecordToServer(record) {
            if (!apiUrl) {
                pendingRecords.push(record);
                saveLocalData();
                return;
            }
            
            try {
                await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'pc_addRecord', ...record })
                });
            } catch (error) {
                pendingRecords.push(record);
                saveLocalData();
            }
        }

        function manualSync() {
            if (apiUrl) {
                syncWithServer();
                showToast('ğŸ”„ ë™ê¸°í™” ì‹œì‘');
            } else {
                openSettingsModal();
            }
        }

        function startAutoSync() {
            if (syncTimer) clearInterval(syncTimer);
            
            if (apiUrl) {
                syncWithServer();
                syncTimer = setInterval(syncWithServer, syncInterval * 1000);
                document.getElementById('connection-banner').classList.add('hidden');
            } else {
                updateSyncStatus('', 'ì˜¤í”„ë¼ì¸');
                document.getElementById('connection-banner').classList.remove('hidden');
            }
        }

        function isOverdue(student) {
            if (!student.lastCheck) return true;
            const diff = Math.floor((new Date() - new Date(student.lastCheck)) / (1000 * 60 * 60 * 24));
            return diff >= 30;
        }

        function getDaysUntilCheck(student) {
            if (!student.lastCheck) return -9999;
            const nextCheck = new Date(student.lastCheck);
            nextCheck.setDate(nextCheck.getDate() + 30);
            return Math.floor((nextCheck - new Date()) / (1000 * 60 * 60 * 24));
        }

        function selectTodayStudents() {
            const count = parseInt(document.getElementById('daily-count')?.value || 6);
            let overdue = allStudents.filter(s => isOverdue(s));
            overdue.sort(() => Math.random() - 0.5);
            todaySelections = overdue.slice(0, Math.min(count, overdue.length));
            saveLocalData();
        }

        function render() {
            renderStudentList();
            renderTodayStudents();
            renderHistory();
            updateStats();
        }

        function renderStudentList() {
            const container = document.getElementById('student-list');
            let filtered = [...allStudents];
            
            if (currentFilter === '7') filtered = filtered.filter(s => s.floor === '7ì¸µ');
            else if (currentFilter === '8') filtered = filtered.filter(s => s.floor === '8ì¸µ');
            else if (currentFilter === 'overdue') filtered = filtered.filter(s => isOverdue(s));
            
            if (searchQuery) {
                filtered = filtered.filter(s => s.name.includes(searchQuery));
            }
            
            filtered.sort((a, b) => getDaysUntilCheck(a) - getDaysUntilCheck(b));
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ”</div><p>í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤</p></div>';
                return;
            }
            
            container.innerHTML = filtered.map(student => {
                const overdue = isOverdue(student);
                const days = getDaysUntilCheck(student);
                const isToday = todaySelections.some(s => s.name === student.name && s.floor === student.floor);
                
                let status = '', statusClass = '', itemClass = '';
                if (!student.lastCheck) {
                    status = 'ë¯¸ì ê²€'; statusClass = 'overdue'; itemClass = 'overdue';
                } else if (overdue) {
                    status = `ì ê²€ í•„ìš” (${Math.abs(days)}ì¼ ê²½ê³¼)`; statusClass = 'overdue'; itemClass = 'overdue';
                } else {
                    status = `${days}ì¼ í›„ ì ê²€ ì˜ˆì •`;
                }
                if (isToday) itemClass = 'today';
                
                const lastCheck = student.lastCheck ? new Date(student.lastCheck).toLocaleDateString('ko-KR') : '-';
                
                return `
                    <div class="student-item ${itemClass}">
                        <span class="floor-badge floor-${student.floor === '7ì¸µ' ? '7' : '8'}">${student.floor}</span>
                        <div class="student-info">
                            <div class="student-name">${student.name}</div>
                            <div class="student-status ${statusClass}">${status} | ìµœê·¼: ${lastCheck}</div>
                        </div>
                        <button class="check-btn" onclick="openConfirmModal('${student.name}', '${student.floor}')">ì ê²€ ì™„ë£Œ</button>
                    </div>
                `;
            }).join('');
        }

        function renderTodayStudents() {
            const container = document.getElementById('today-students');
            
            if (todaySelections.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">âœ…</div><p>ì ê²€ ì™„ë£Œ!</p></div>';
                return;
            }
            
            container.innerHTML = todaySelections.map((student, i) => {
                const original = allStudents.find(s => s.name === student.name && s.floor === student.floor);
                const lastCheck = original?.lastCheck ? new Date(original.lastCheck).toLocaleDateString('ko-KR') : 'ë¯¸ì ê²€';
                
                return `
                    <div class="today-item">
                        <span class="priority-num">${i + 1}</span>
                        <div class="student-info">
                            <div class="student-name">${student.name}</div>
                            <div class="student-status">
                                <span class="floor-badge floor-${student.floor === '7ì¸µ' ? '7' : '8'}">${student.floor}</span>
                                ìµœê·¼: ${lastCheck}
                            </div>
                        </div>
                        <button class="check-btn" onclick="openConfirmModal('${student.name}', '${student.floor}')">âœ“</button>
                    </div>
                `;
            }).join('');
        }

        function renderHistory() {
            const container = document.getElementById('history-list');
            
            if (inspectionHistory.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“‹</div><p>ì ê²€ ì´ë ¥ ì—†ìŒ</p></div>';
                return;
            }
            
            container.innerHTML = inspectionHistory.slice(-20).reverse().map(item => `
                <div class="history-item">
                    <div>
                        <span class="floor-badge floor-${item.floor === '7ì¸µ' ? '7' : '8'}">${item.floor}</span>
                        <strong>${item.name}</strong>
                    </div>
                    <div class="date">${new Date(item.date).toLocaleDateString('ko-KR')}</div>
                </div>
            `).join('');
        }

        function updateStats() {
            const total = allStudents.length;
            const overdue = allStudents.filter(s => isOverdue(s)).length;
            const completed = allStudents.filter(s => !isOverdue(s)).length;
            
            const now = new Date();
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const thisMonth = inspectionHistory.filter(r => new Date(r.date) >= monthStart).length;
            
            document.getElementById('total-students').textContent = total;
            document.getElementById('overdue-count').textContent = overdue;
            document.getElementById('completed-month').textContent = thisMonth;
            
            const percent = total > 0 ? Math.round((completed / total) * 100) : 0;
            document.getElementById('progress-fill').style.width = percent + '%';
            document.getElementById('progress-text').textContent = `ì ê²€ ì§„í–‰ë¥ : ${percent}% (${completed}/${total}ëª…)`;
        }

        function openConfirmModal(name, floor) {
            selectedStudent = { name, floor };
            document.getElementById('modal-title').textContent = `${name} ì ê²€ ì™„ë£Œ`;
            document.getElementById('modal-message').textContent = `${floor} ${name} í•™ìƒì˜ PC/íƒœë¸”ë¦¿ ì ê²€ì„ ì™„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
            document.getElementById('confirm-modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('confirm-modal').classList.remove('active');
            selectedStudent = null;
        }

        async function completeInspection() {
            if (!selectedStudent) return;
            
            const now = new Date();
            const record = { name: selectedStudent.name, floor: selectedStudent.floor, date: now.toISOString() };
            
            const idx = allStudents.findIndex(s => s.name === selectedStudent.name && s.floor === selectedStudent.floor);
            if (idx !== -1) {
                allStudents[idx].lastCheck = now.toISOString();
            }
            
            inspectionHistory.push(record);
            todaySelections = todaySelections.filter(s => !(s.name === selectedStudent.name && s.floor === selectedStudent.floor));
            
            saveLocalData();
            closeModal();
            saveRecordToServer(record);
            render();
            showToast(`âœ… ${selectedStudent.name} ì ê²€ ì™„ë£Œ!`, 'success');
        }

        function openSettingsModal() {
            document.getElementById('api-url-input').value = apiUrl;
            document.getElementById('sync-interval-input').value = syncInterval;
            document.getElementById('settings-modal').classList.add('active');
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').classList.remove('active');
        }

        function saveSettings() {
            apiUrl = document.getElementById('api-url-input').value.trim();
            syncInterval = Math.max(10, Math.min(300, parseInt(document.getElementById('sync-interval-input').value) || 30));
            
            localStorage.setItem('pc-inspection-api-url', apiUrl);
            localStorage.setItem('pc-inspection-sync-interval', syncInterval);
            
            closeSettingsModal();
            startAutoSync();
            
            if (apiUrl) showToast('âœ… ì„¤ì • ì €ì¥ë¨', 'success');
        }

        function showToast(msg, type = '') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = 'toast ' + type + ' show';
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function exportData() {
            const blob = new Blob([JSON.stringify({ students: allStudents, history: inspectionHistory }, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `pc-inspection-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            showToast('ğŸ“¥ ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì™„ë£Œ');
        }

        function resetData() {
            if (confirm('ëª¨ë“  ì ê²€ ê¸°ë¡ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('pc-inspection-data');
                allStudents = [];
                inspectionHistory = [];
                todaySelections = [];
                pendingRecords = [];
                startAutoSync();
                showToast('ğŸ—‘ï¸ ì´ˆê¸°í™” ì™„ë£Œ');
            }
        }

        window.addEventListener('beforeunload', saveLocalData);
    </script>
</body>
</html>
